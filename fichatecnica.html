<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha T√©cnica | CLENA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6f8;
  --card:#fff;
}
body{
  margin:0;
  padding:20px;
  background:var(--bg);
  font-family:Inter,Arial,sans-serif;
}
.container{max-width:1200px;margin:auto}
.card{
  background:var(--card);
  padding:22px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
  margin-bottom:24px;
}
label{font-weight:600;margin-top:12px;display:block}
input,select,textarea,button{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ddd;
  margin-top:6px;
}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}
.grid{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:8px;
  margin-top:10px;
}
.lista{
  position:absolute;
  background:#fff;
  border:1px solid #ddd;
  border-radius:10px;
  max-height:240px;
  overflow:auto;
  z-index:20;
}
.item{padding:10px;cursor:pointer}
.item:hover{background:#fff7ed}
.badge{
  display:inline-block;
  background:#fff7ed;
  padding:6px 12px;
  border-radius:999px;
  margin-top:6px;
}
.totais{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:16px;
}
.totais div{
  background:#fafafa;
  padding:14px;
  border-radius:10px;
  text-align:center;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #e5e7eb;
  padding:10px;
}
tr:hover{background:#f9fafb;cursor:pointer}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:#fff;
  padding:22px;
  border-radius:14px;
  max-width:700px;
  width:100%;
  max-height:90vh;
  overflow:auto;
}
</style>
</head>

<body>
<div class="container">

<!-- ================= CADASTRO ================= -->
<div class="card">
<h2>üìã Ficha T√©cnica</h2>

<label>Produto</label>
<div style="position:relative">
  <input id="buscaProduto" placeholder="Digite o nome do produto">
  <div id="listaBusca" class="lista" style="display:none"></div>
</div>

<div class="badge">
  Unidade: <strong id="unProduto">‚Äî</strong>
</div>

<h3>üç≥ Receita</h3>
<div class="grid">
  <input id="ing" placeholder="Ingrediente">
  <input id="qtd" type="number" placeholder="Qtd">
  <select id="un">
    <option>g</option><option>kg</option><option>ml</option><option>l</option>
    <option>un</option><option>pct</option>
  </select>
  <input id="custo" type="number" placeholder="Custo unit.">
  <button onclick="addIngrediente()">+</button>
</div>

<div id="listaIng"></div>

<label>Rendimento</label>
<input id="rendimento" type="number">

<div class="totais">
  <div>Custo Total<br><strong>R$ <span id="total">0.00</span></strong></div>
  <div>Rendimento<br><strong id="rend">0</strong></div>
  <div>Custo Unit√°rio<br><strong>R$ <span id="unit">0.00</span></strong></div>
</div>

<button onclick="salvar()">Salvar Ficha T√©cnica</button>
</div>

<!-- ================= LISTAGEM ================= -->
<div class="card">
<h3>üìö Fichas Cadastradas</h3>
<table id="tabela">
<tr><th>Produto</th><th>Unidade</th><th>Custo Unit.</th></tr>
</table>
</div>

<!-- ================= MODAL ================= -->
<div class="modal" id="modal">
  <div class="modal-content">
    <button onclick="modal.style.display='none'">Fechar</button>
    <pre id="modalConteudo"></pre>
  </div>
</div>

</div>

<script>
/* üîê SUPABASE */
const supabase = supabasejs.createClient(
  "SUA_SUPABASE_URL",
  "SUA_SUPABASE_ANON_KEY"
);

let produtoSelecionado=null;
let receita=[];
let total=0;

/* üîç BUSCA PRODUTO (API VAREJO EXISTENTE) */
buscaProduto.oninput=async()=>{
  const q=buscaProduto.value.trim();
  if(q.length<2){listaBusca.style.display="none";return;}

  const r=await fetch(`/api/buscar-produto?q=${q}`);
  const j=await r.json();

  listaBusca.innerHTML=j.items.map(p=>`
    <div class="item" onclick='selectProduto(${JSON.stringify(p)})'>
      ${p.descricao}
    </div>`).join("");
  listaBusca.style.display="block";
};

function selectProduto(p){
  produtoSelecionado=p;
  buscaProduto.value=p.descricao;
  unProduto.innerText=p.unidadeDeVenda||"‚Äî";
  listaBusca.style.display="none";
}

/* üç≥ RECEITA */
function addIngrediente(){
  const t=qtd.value*custo.value;
  receita.push({ing:ing.value,qtd:qtd.value,un:un.value,custo:custo.value,total:t});
  total+=t;
  render();
}

function render(){
  listaIng.innerHTML=receita.map(r=>`<p>${r.ing} - R$ ${r.total}</p>`).join("");
  totalSpan.innerText=total.toFixed(2);
  rend.innerText=rendimento.value||0;
  unit.innerText=rendimento.value?(total/rendimento.value).toFixed(2):"0.00";
}

/* üíæ SALVAR */
async function salvar(){
  await supabase.from("ficha_tecnica").insert({
    produto_id:produtoSelecionado.id,
    produto_nome:produtoSelecionado.descricao,
    unidade_produto:produtoSelecionado.unidadeDeVenda,
    receita,
    rendimento:rendimento.value,
    custo_total:total,
    custo_unitario:total/rendimento.value
  });
  alert("Salvo");
  carregar();
}

/* üìö LISTAR */
async function carregar(){
  const {data}=await supabase.from("ficha_tecnica").select("*").order("created_at",{ascending:false});
  tabela.innerHTML=`<tr><th>Produto</th><th>Un</th><th>Custo</th></tr>`+
    data.map(d=>`
      <tr onclick='abrir(${JSON.stringify(d)})'>
        <td>${d.produto_nome}</td>
        <td>${d.unidade_produto}</td>
        <td>R$ ${d.custo_unitario}</td>
      </tr>`).join("");
}

function abrir(d){
  modal.style.display="flex";
  modalConteudo.textContent=JSON.stringify(d,null,2);
}

carregar();
</script>
</body>
</html>
