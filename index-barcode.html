<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de C√≥digo de Barras ‚Äì Envio para Planilha</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  font-family:Inter,Arial;
  background:#f4f6f8;
}
h1{font-size:22px;text-align:center}

button{
  width:100%;
  padding:16px;
  font-size:18px;
  font-weight:700;
  border:none;
  border-radius:16px;
  background:#ff6a00;
  color:#fff;
  margin-top:10px;
  cursor:pointer;
}
button.secondary{background:#0f172a}
button.green{background:#16a34a}

input,textarea{
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  margin-top:10px;
}

video{
  width:100%;
  margin-top:14px;
  border-radius:18px;
  background:#000;
}

.card{
  background:#fff;
  padding:18px;
  border-radius:18px;
  margin-top:14px;
}

pre{
  background:#020617;
  color:#e5e7eb;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  max-height:280px;
  overflow:auto;
  font-size:13px;
}
</style>
</head>

<body>

<h1>üì¶ Leitura de C√≥digo de Barras</h1>

<button id="btnCamera">üì∑ Abrir c√¢mera</button>

<input id="manual" placeholder="Digite o c√≥digo de barras">
<button class="secondary" id="btnManual">üîç Buscar manualmente</button>

<video id="video" autoplay playsinline muted></video>

<div id="resultado"></div>

<label>Quantidade</label>
<input type="number" id="quantidade" min="1" placeholder="Quantidade">

<label>Observa√ß√µes</label>
<textarea id="observacoes" placeholder="Opcional"></textarea>

<button class="green" id="btnEnviar">üì§ Enviar para planilha</button>

<pre id="debug"></pre>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
/* ================= CONFIG ================= */
const URL_GAS = "https://script.google.com/macros/s/AKfycbyXFEAq56G7oQdeCzGw_SdOnQ7XkRPMzBoS1V09Pkk_wI916FGO9nn4e9FfeNmv8KV9KA/exec";

/* ================= STATE ================= */
let lendo = false;
let buscando = false;
let ultimoCodigo = null;
let produtoAtual = null;

/* ================= ELEMENTS ================= */
const debug = document.getElementById("debug");
const video = document.getElementById("video");
const resultado = document.getElementById("resultado");

/* ================= UTILS ================= */
function log(txt){
  debug.textContent += txt + "\n";
  debug.scrollTop = debug.scrollHeight;
}

function normalizarCodigo(code){
  const c = String(code).trim();
  if(c.length >= 13) return c;   // EAN-13
  return "0" + c;               // UPC ‚Üí EAN
}

/* ================= CAMERA ================= */
document.getElementById("btnCamera").onclick = () => {
  if(lendo) return;
  iniciarLeitura();
};

function iniciarLeitura(){
  lendo = true;
  log("üì∑ Iniciando leitura com c√¢mera");

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:video,
      constraints:{ facingMode:"environment" }
    },
    decoder:{
      readers:[
        "ean_reader",
        "upc_reader",
        "code_128_reader"
      ]
    },
    locate:true
  }, err=>{
    if(err){
      log("‚ùå ERRO QUAGGA: " + err.message);
      lendo = false;
      return;
    }
    Quagga.start();
    log("‚úÖ C√¢mera ativa");
  });

  Quagga.onDetected(res=>{
    if(buscando) return;

    const raw = res.codeResult?.code;
    if(!raw) return;

    const codigo = normalizarCodigo(raw);
    if(codigo === ultimoCodigo) return;

    ultimoCodigo = codigo;
    buscarProduto(codigo);
  });
}

/* ================= MANUAL ================= */
document.getElementById("btnManual").onclick = () => {
  const raw = document.getElementById("manual").value.trim();
  if(!raw) return;
  buscarProduto(normalizarCodigo(raw));
};

/* ================= BUSCAR PRODUTO ================= */
async function buscarProduto(barcode){
  buscando = true;
  log("üîç Buscando produto: " + barcode);

  try{
    const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`);
    const json = await resp.json();

    if(!json.items || !json.items.length){
      log("‚ö†Ô∏è Produto n√£o encontrado");
      buscando = false;
      return;
    }

    produtoAtual = {
      codigo: barcode,
      descricao: json.items[0].descricao,
      id: json.items[0].id
    };

    resultado.innerHTML = `
      <div class="card">
        <h2>${produtoAtual.descricao}</h2>
        <p><b>C√≥digo:</b> ${produtoAtual.codigo}</p>
        <p><b>ID:</b> ${produtoAtual.id}</p>
      </div>
    `;

    if(lendo){
      Quagga.stop();
      lendo = false;
      log("üõë C√¢mera parada");
    }

  }catch(err){
    log("‚ùå ERRO BUSCA: " + err.message);
  }finally{
    buscando = false;
  }
}

/* ================= ENVIAR PARA PLANILHA ================= */
document.getElementById("btnEnviar").onclick = async () => {
  if(!produtoAtual){
    alert("Nenhum produto selecionado");
    return;
  }

  const quantidade = document.getElementById("quantidade").value;
  const observacoes = document.getElementById("observacoes").value;

  if(!quantidade){
    alert("Informe a quantidade");
    return;
  }

  log("üì§ Enviando para planilha...");

  try{
    await fetch(URL_GAS,{
      method:"POST",
      body:JSON.stringify({
        acao:"cadastrar",
        codigo_barras: produtoAtual.codigo,
        produto: produtoAtual.descricao,
        quantidade: quantidade,
        observacoes: observacoes
      })
    });

    alert("‚úÖ Enviado com sucesso!");
    resultado.innerHTML = "";
    produtoAtual = null;
    document.getElementById("quantidade").value = "";
    document.getElementById("observacoes").value = "";

  }catch(err){
    alert("‚ùå Erro ao enviar");
    log(err.message);
  }
};
</script>

</body>
</html>
