<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Requisi√ß√£o de Compras - DEL√çCIA GOURMET</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter, Arial;
  background:#f5f5f5;
  display:flex;
  justify-content:center;
  padding:30px;
}
.container{
  background:#fff;
  border-radius:14px;
  box-shadow:0 0 15px rgba(0,0,0,.1);
  max-width:520px;
  width:100%;
  padding:25px;
  position:relative;
}
h2{text-align:center;margin-bottom:20px}
label{display:block;margin:12px 0 6px;font-weight:600}
input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}
textarea{resize:vertical}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  font-size:16px;
}
.btn-blue{background:#2196F3;color:#fff}
.btn-red{background:#f44336;color:#fff}
video{
  width:100%;
  margin-top:10px;
  border-radius:10px;
  background:#000;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
#msg{text-align:center;margin-top:8px;font-weight:600}
#spinner{
  display:none;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  border:8px solid #eee;
  border-top:8px solid #2196F3;
  border-radius:50%;
  width:60px;
  height:60px;
  animation:spin 1s linear infinite;
}
@keyframes spin{
  from{transform:translate(-50%,-50%) rotate(0)}
  to{transform:translate(-50%,-50%) rotate(360deg)}
}
</style>
</head>

<body>
<div class="container">

<h2>üìã Requisi√ß√£o de Compras<br>DEL√çCIA GOURMET</h2>

<label>Solicitante</label>
<select id="solicitante">
  <option value="">Selecione</option>
  <option>ADM</option><option>Ruan</option><option>Renata</option>
  <option>Lu</option><option>Bruna</option><option>Renan</option>
  <option>Dheure</option><option>Marcelo</option>
</select>

<label>Setor</label>
<select id="setor">
  <option value="">Selecione</option>
  <option>Cozinha</option><option>Limpeza</option><option>Bar</option>
  <option>Sushi</option><option>Ger√™ncia</option>
</select>

<hr>

<label>C√≥digo de Barras</label>
<input id="barcode" placeholder="Digite ou escaneie o c√≥digo">

<button class="btn-blue" onclick="abrirCamera()">üì∑ Ler c√≥digo de barras</button>

<video id="video" autoplay playsinline muted></video>

<label>Produto</label>
<input id="produto" readonly placeholder="Produto ser√° buscado automaticamente">

<label>Quantidade</label>
<input type="number" id="quantidade" min="1">

<label>Observa√ß√µes</label>
<textarea id="observacoes"></textarea>

<div id="spinner"></div>

<button class="btn-blue" onclick="enviarItem()">ENVIAR ITEM</button>
<button class="btn-red" onclick="limparTabela()">LIMPAR HIST√ìRICO</button>

<p id="msg"></p>

<h3>Itens enviados nesta sess√£o</h3>
<table id="historico">
  <tr>
    <th>Produto</th>
    <th>Qtd</th>
    <th>Setor</th>
    <th>Hora</th>
    <th>Status</th>
  </tr>
</table>

</div>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
const URL_GAS = "https://script.google.com/macros/s/AKfycbyXFEAq56G7oQdeCzGw_SdOnQ7XkRPMzBoS1V09Pkk_wI916FGO9nn4e9FfeNmv8KV9KA/exec";

let lendo=false, buscando=false, ultimoCodigo=null;
let enviados = JSON.parse(localStorage.getItem("enviados")) || [];

const video = document.getElementById("video");

function normalizarCodigo(c){
  c=String(c).trim();
  if(c.length>=13) return c;
  return "0"+c;
}

// ================= CAMERA
function abrirCamera(){
  if(lendo) return;
  lendo=true;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:video,
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader","upc_reader","code_128_reader"]},
    locate:true
  },err=>{
    if(err){alert(err.message);return}
    Quagga.start();
  });

  Quagga.onDetected(res=>{
    if(buscando) return;
    const code=res.codeResult?.code;
    if(!code) return;

    const final=normalizarCodigo(code);
    if(final===ultimoCodigo) return;

    ultimoCodigo=final;
    buscarProduto(final);
  });
}

// ================= BUSCA PRODUTO
async function buscarProduto(barcode){
  buscando=true;
  document.getElementById("barcode").value=barcode;

  try{
    const r=await fetch(`/api/buscar-barcode?barcode=${barcode}`);
    const j=await r.json();

    if(!j.items || !j.items.length){
      alert("Produto n√£o encontrado");
      return;
    }

    document.getElementById("produto").value=j.items[0].descricao;
    Quagga.stop();
    lendo=false;

  }finally{
    buscando=false;
  }
}

// ================= ENVIO
function enviarItem(){
  const solicitante=solicitante.value;
  const setor=setor.value;
  const produto=produto.value;
  const qtd=quantidade.value;
  const obs=observacoes.value;
  const hora=new Date().toLocaleTimeString();

  if(!solicitante||!setor||!produto||!qtd){
    msg.innerText="‚ö†Ô∏è Preencha tudo";
    return;
  }

  spinner.style.display="block";

  enviados.push({produto,qtd,setor,hora,status:"Processando"});
  atualizarTabela();

  fetch(URL_GAS,{
    method:"POST",
    body:JSON.stringify({
      acao:"cadastrar",
      solicitante,
      setor,
      produto,
      quantidade:qtd,
      observacoes:obs
    })
  }).then(()=>{
    enviados[enviados.length-1].status="Enviado";
    atualizarTabela();
    limparCampos();
    alert("‚úÖ Enviado com sucesso");
  }).finally(()=>{
    spinner.style.display="none";
  });
}

// ================= UTIL
function limparCampos(){
  barcode.value="";
  produto.value="";
  quantidade.value="";
  observacoes.value="";
}
function atualizarTabela(){
  const t=document.getElementById("historico");
  t.innerHTML=`<tr><th>Produto</th><th>Qtd</th><th>Setor</th><th>Hora</th><th>Status</th></tr>`;
  enviados.forEach(i=>{
    const r=t.insertRow();
    r.insertCell(0).innerText=i.produto;
    r.insertCell(1).innerText=i.qtd;
    r.insertCell(2).innerText=i.setor;
    r.insertCell(3).innerText=i.hora;
    r.insertCell(4).innerText=i.status;
  });
  localStorage.setItem("enviados",JSON.stringify(enviados));
}
function limparTabela(){
  enviados=[];
  atualizarTabela();
}

atualizarTabela();
</script>

</body>
</html>
